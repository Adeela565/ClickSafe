<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{ title or "Results" }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f6f7fb;color:#1f2937}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{margin:10px 0}
    .bar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:12px 0 18px}
    select,button{padding:8px 10px;border:1px solid #d1d5db;border-radius:6px;background:#fff}
    a.btn{display:inline-block;padding:8px 12px;border-radius:6px;background:#2563eb;color:#fff;text-decoration:none}
    .statbox{display:flex;gap:12px;margin:12px 0}
    .stat{background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:10px 14px;min-width:160px}
    table{width:100%;border-collapse:collapse;background:#fff;border:1px solid #e5e7eb}
    th,td{padding:10px 12px;border-bottom:1px solid #eef2f7;font-size:14px}
    th{background:#f8fafc;text-align:left}
    .ts{white-space:nowrap}
    
    .back-link {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 0.9rem;
    margin-bottom: 14px;
    color: #2563eb;
    text-decoration: none;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Campaign Results</h1>
    <div class="bar" style="margin:6px 0 14px;">
        <a class="back-link" href="{{ url_for('main.send_campaign') }}">
            ← Back to Campaigns
        </a>
    </div>

    <!-- Filter / Actions -->
    <form class="bar" method="get" action="/results">
      <label for="campaign_id"><strong>Filter by Campaign:</strong></label>
      <select id="campaign_id" name="campaign_id" onchange="this.form.submit()">
        <option value="">All campaigns</option>
        {% for c in campaigns %}
          <option value="{{ c.id }}" {% if campaign_id==c.id %}selected{% endif %}>{{ c.name }}</option>
        {% endfor %}
      </select>

      <!-- CSV export keeps same filter via querystring -->
      <a class="btn" href="/results.csv{% if campaign_id %}?campaign_id={{ campaign_id }}{% endif %}">Download CSV</a>
    </form>
    
	<form class="bar" method="post" action="/results/delete"
     		onsubmit="return confirm('Delete selected campaigns and all their events? This cannot be undone.');">
	  <label for="del_campaigns"><strong>Delete Campaigns:</strong></label>

	  <!-- Multi-select: choose one or more campaigns, or choose ALL -->
	  <select id="del_campaigns" name="campaign_ids" multiple size="3"
		  style="min-width:260px">
	    <option value="ALL">All campaigns</option>
	    {% for c in campaigns %}
	      <option value="{{ c.id }}">{{ c.name }}</option>
	    {% endfor %}
	  </select>

	  <button type="submit" class="btn"
		  style="background:#ef4444;color:#fff;border:none;">
	    Delete Selected
	  </button>
	</form>


    <!-- Summary statistics -->
    <div class="statbox">
      <div class="stat"><strong>Total Delivered</strong><div>{{ total_delivered }}</div></div>
      <div class="stat"><strong>Total Clicks</strong><div>{{ total_clicked }}</div></div>
      <div class="stat"><strong>Total Reported</strong><div>{{ total_reported }}</div></div>
    </div>

    <!-- Events table (includes timestamp column) -->
    <table>
      <thead>
        <tr>
          <th>Campaign</th>
          <th>Recipient</th>
          <th>Event</th>
          <th>IP</th>
          <th class="ts">Timestamp</th>
        </tr>
      </thead>
      <tbody>
        {% for e in events %}
        <tr>
          <td>{{ e.campaign_name }}</td>
          <td>{{ e.recipient_email }}</td>
          <td>{{ e.event_type }}</td>
          <td>{{ e.ip or "—" }}</td>
          <td class="ts">{{ e.ts }}</td>
        </tr>
        {% else %}
        <tr><td colspan="6" style="text-align:center;color:#6b7280;padding:18px;">No events found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</body>
</html>

